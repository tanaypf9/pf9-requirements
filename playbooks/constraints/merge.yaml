---
- hosts: all
  tasks:
  - name: Install expected "bits"
    become: true
    package:
      name:
      - build-essential
      - git
      - python3-all
      - python3-pip
      - python3-all-dev
      - python3-venv
      - tox
      state: present

  - name: Create a venv for requirements code
    command: python3 -m venv {{ requirements_dir }}/.venv

  - name: Install everything in openstack_requirements
    command: |-
      {{ requirements_dir }}/.venv/bin/pip install -e {{ requirements_dir }}

  - name: Set freeze_name fact
    set_fact:
      freeze_name: "freeze_{{ pyver|replace('.', '_') }}"

  - name: Generate a set of constraints for a single python version
    copy:
      dest: "{{ artifacts_dir }}/{{ pyver }}_freeze.txt"
      content: "{{ freeze_sets[freeze_name] }}"
    loop: "{{ python_versions }}"
    loop_control:
      loop_var: pyver

  - name: Debugging fu
    debug:
      msg: |-
      {{ freeze_sets[freeze_name] }}
      ----
      {{ freeze_name }}
      ----
      freeze_sets
    loop: "{{ python_versions }}"
    loop_control:
      loop_var: pyver
